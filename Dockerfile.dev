FROM golang:1.23-alpine

WORKDIR /app

# Install Node.js and npm for frontend build
RUN apk add --no-cache nodejs npm

# Install air for hot reloading (compatible version)
RUN go install github.com/cosmtrek/air@v1.49.0

# Copy go mod files
COPY go.mod go.sum ./

# Download Go dependencies
RUN go mod download

# Copy frontend package files
COPY frontend/package*.json ./frontend/

# Install frontend dependencies
RUN cd frontend && npm ci

# Copy source code (both Go and frontend)
COPY . .

# Build frontend for production
RUN cd frontend && npm run build

# Create static directory and copy built frontend
RUN mkdir -p /app/static
RUN if [ -d "/app/frontend/out" ]; then cp -r /app/frontend/out/* /app/static/; fi
RUN if [ -d "/app/frontend/.next" ] && [ ! -d "/app/frontend/out" ]; then cp -r /app/frontend/.next/static /app/static/_next && cp /app/frontend/.next/server/app/index.html /app/static/ 2>/dev/null || true; fi

# Expose port
EXPOSE 8080

# Use air for hot reloading in development
CMD ["air"]